<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Asciidoctor 1.5.4"><meta name="keywords" content="documentation, physics, character, NPC, forces, collisions"><title>Ragdoll Physics</title><link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css"></head><body class="article toc2 toc-left"><div id="header"><div id="toolbar"><a href="https://github.com/jMonkeyEngine/wiki/edit/master/src/docs/asciidoc/jme3/advanced/ragdoll.adoc"><i class="fa fa-pencil-square" aria-hidden="true"></i></a><a href="https://github.com/jMonkeyEngine/wiki/new/master/src/docs/asciidoc/jme3/advanced/"><i class="fa fa-plus-square" aria-hidden="true"></i></a><input dir="auto" style="position: relative; vertical-align: top;" spellcheck="false" autocomplete="off" class="searchbox__input aa-input" id="doc-search" name="search" placeholder="Search in the doc" required="required" type="search"></div><h1>Ragdoll Physics</h1><div class="details"><span class="author" id="author"></span><br><span id="revnumber">version ,</span> <span id="revdate">2016/03/17 20:48</span></div><div id="toc" class="toc2"><div id="toctitle">Table of Contents</div><ul class="sectlevel1"><li><a href="#sample-code">Sample Code</a></li><li><a href="#preparing-the-physics-game">Preparing the Physics Game</a></li><li><a href="#creating-the-ragdoll">Creating the Ragdoll</a><ul class="sectlevel2"><li><a href="#limbs">Limbs</a></li><li><a href="#joints">Joints</a></li><li><a href="#attaching-everything-to-the-scene">Attaching Everything to the Scene</a></li></ul></li><li><a href="#applying-forces">Applying Forces</a></li><li><a href="#detecting-collisions">Detecting Collisions</a></li><li><a href="#best-practices">Best Practices</a></li></ul></div></div><div id="content"><div id="preamble"><div class="sectionbody"><div class="paragraph"><p>The jMonkeyEngine3 has built-in support for <a href="http://jbullet.advel.cz">jBullet physics</a> via the <code>com.jme3.bullet</code> package. Physics are not only responsible for handing collisions, but they also make <a href="../../jme3/advanced/hinges_and_joints.html">hinges and joints</a> possible. One special example of physical joints are ragdoll physics, shown here.</p></div>
<div style="text-align: center;" class="imageblock"><div class="content"><img src="../../jme3/advanced/ragdoll.png" alt="ragdoll.png" width="" height=""></div></div></div></div>
<div class="sect1"><h2 id="sample-code">Sample Code</h2><div class="sectionbody"><div class="ulist"><ul><li><p><a href="https://github.com/jMonkeyEngine/jmonkeyengine/blob/master/jme3-examples/src/main/java/jme3test/bullet/TestRagDoll.java">TestRagDoll.java</a> (Tip: Click to pull the ragdoll up)</p></li><li><p><a href="https://github.com/jMonkeyEngine/jmonkeyengine/blob/master/jme3-examples/src/main/java/jme3test/bullet/TestBoneRagdoll.java">TestBoneRagdoll.java</a> – This ragdoll replaces a rigged model of a character in the moment it is “shot to simulate a collapsing person. (Also note DoF of the limbs.)</p></li></ul></div></div></div>
<div class="sect1"><h2 id="preparing-the-physics-game">Preparing the Physics Game</h2><div class="sectionbody"><div class="olist arabic"><ol class="arabic"><li><p>Create a SimpleApplication with a <a href="../../jme3/advanced/physics.html">BulletAppState</a></p><div class="ulist"><ul><li><p>This gives us a PhysicsSpace for PhysicControls</p></li></ul></div></li><li><p>Add a physical floor (A box collision shape with mass zero)</p></li></ol></div></div></div>
<div class="sect2"><h3 id="creating-the-ragdoll">Creating the Ragdoll</h3><div class="paragraph"><p>A ragdoll is a simple “person (dummy) that you build out of cylinder collision shapes. The ragdoll has 11 limbs: 1 for shoulders, 1 for the body, 1 for hips; plus 2 arms and 2 legs that are made up of two limbs each. In your game, you will likely replace the cylinders with your own (better looking) limb models. In this example here we just use simple cylinders.</p></div>
<div class="sect2"><h3 id="limbs">Limbs</h3><div class="paragraph"><p>Since you&#8217;re just creating the ragdoll for this example, all the limbs have the same shape, and you can write a simple helper method to create them. The function returns a PhysicsControl with CollisionShape with the width, height, location, and rotation (vertical or horizontal) that you specify. You choose a CapsuleCollisionShape (a cylinder with rounded top and bottom) so the limbs collide smoothly against one another.</p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> Node createLimb(<span class="type">float</span> width, <span class="type">float</span> height, Vector3f location, <span class="type">boolean</span> rotate) {
        <span class="type">int</span> axis = rotate ? PhysicsSpace.AXIS_X : PhysicsSpace.AXIS_Y;
        CapsuleCollisionShape shape = <span class="keyword">new</span> CapsuleCollisionShape(width, height, axis);
        Node node = <span class="keyword">new</span> Node(<span class="string"><span class="delimiter">&quot;</span><span class="content">Limb</span><span class="delimiter">&quot;</span></span>);
        RigidBodyControl rigidBodyControl = <span class="keyword">new</span> RigidBodyControl(shape, <span class="integer">1</span>);
        node.setLocalTranslation(location);
        node.addControl(rigidBodyControl);
        <span class="keyword">return</span> node;
}</code></pre></div></div>
<div class="paragraph"><p>You write a custom helper method to initialize the limbs. Look at the screenshot above for orientation.</p></div>
<div class="ulist"><ul><li><p>All cylinders have the same diameter, 0.2f.</p></li><li><p>You make the body and shoulders longer than the other limbs, 1.0f instead of 0.5f.</p></li><li><p>You determine the coordinates for positioning the limbs to form a person.</p></li><li><p>The shoulders and hips are <em>vertical</em> cylinders, this is why we set the rotation to true.</p></li></ul></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java">Node shoulders = createLimb(<span class="float">0.2f</span>, <span class="float">1.0f</span>, <span class="keyword">new</span> Vector3f( <span class="float">0.00f</span>, <span class="float">1.5f</span>, <span class="integer">0</span>), <span class="predefined-constant">true</span>);
Node     uArmL = createLimb(<span class="float">0.2f</span>, <span class="float">0.5f</span>, <span class="keyword">new</span> Vector3f(-<span class="float">0.75f</span>, <span class="float">0.8f</span>, <span class="integer">0</span>), <span class="predefined-constant">false</span>);
Node     uArmR = createLimb(<span class="float">0.2f</span>, <span class="float">0.5f</span>, <span class="keyword">new</span> Vector3f( <span class="float">0.75f</span>, <span class="float">0.8f</span>, <span class="integer">0</span>), <span class="predefined-constant">false</span>);
Node     lArmL = createLimb(<span class="float">0.2f</span>, <span class="float">0.5f</span>, <span class="keyword">new</span> Vector3f(-<span class="float">0.75f</span>,-<span class="float">0.2f</span>, <span class="integer">0</span>), <span class="predefined-constant">false</span>);
Node     lArmR = createLimb(<span class="float">0.2f</span>, <span class="float">0.5f</span>, <span class="keyword">new</span> Vector3f( <span class="float">0.75f</span>,-<span class="float">0.2f</span>, <span class="integer">0</span>), <span class="predefined-constant">false</span>);
Node      body = createLimb(<span class="float">0.2f</span>, <span class="float">1.0f</span>, <span class="keyword">new</span> Vector3f( <span class="float">0.00f</span>, <span class="float">0.5f</span>, <span class="integer">0</span>), <span class="predefined-constant">false</span>);
Node      hips = createLimb(<span class="float">0.2f</span>, <span class="float">0.5f</span>, <span class="keyword">new</span> Vector3f( <span class="float">0.00f</span>,-<span class="float">0.5f</span>, <span class="integer">0</span>), <span class="predefined-constant">true</span>);
Node     uLegL = createLimb(<span class="float">0.2f</span>, <span class="float">0.5f</span>, <span class="keyword">new</span> Vector3f(-<span class="float">0.25f</span>,-<span class="float">1.2f</span>, <span class="integer">0</span>), <span class="predefined-constant">false</span>);
Node     uLegR = createLimb(<span class="float">0.2f</span>, <span class="float">0.5f</span>, <span class="keyword">new</span> Vector3f( <span class="float">0.25f</span>,-<span class="float">1.2f</span>, <span class="integer">0</span>), <span class="predefined-constant">false</span>);
Node     lLegL = createLimb(<span class="float">0.2f</span>, <span class="float">0.5f</span>, <span class="keyword">new</span> Vector3f(-<span class="float">0.25f</span>,-<span class="float">2.2f</span>, <span class="integer">0</span>), <span class="predefined-constant">false</span>);
Node     lLegR = createLimb(<span class="float">0.2f</span>, <span class="float">0.5f</span>, <span class="keyword">new</span> Vector3f( <span class="float">0.25f</span>,-<span class="float">2.2f</span>, <span class="integer">0</span>), <span class="predefined-constant">false</span>);</code></pre></div></div>
<div class="paragraph"><p>You now have the outline of a person. But if you ran the application now, the individual limbs would fall down independently of one another – the ragdoll is still lacking joints.</p></div></div>
<div class="sect2"><h3 id="joints">Joints</h3><div class="paragraph"><p>As before, you write a small helper method. This time its purpose is to quickly join two limbs A and B at the connection point that we specify.</p></div>
<div class="ulist"><ul><li><p>Convert A&#8217;s and B&#8217;s connectionPoint vector from world coordinate space to local coordinate space.</p></li><li><p>Use a ConeJoint, a special joint that approximates the degree of freedom that limbs typically have. The ConeJoint constructor requires the two nodes, and the two local pivot coordinates that we just determined.</p></li><li><p>Set the joints limits to allow swinging, but not twisting.</p></li></ul></div>
<div class="listingblock"><div class="content"><pre>private PhysicsJoint join(Node A, Node B, Vector3f connectionPoint) {
        Vector3f pivotA = A.worldToLocal(connectionPoint, new Vector3f());
        Vector3f pivotB = B.worldToLocal(connectionPoint, new Vector3f());
        ConeJoint joint = new ConeJoint(A.getControl(RigidBodyControl.class),
                                        B.getControl(RigidBodyControl.class),
                                        pivotA, pivotB);
        joint.setLimit(1f, 1f, 0);
        return joint;
}</pre></div></div>
<div class="paragraph"><p>Use the helper method to connect all limbs with joints where they belong, at one end of the limb.</p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java">join(body,  shoulders, <span class="keyword">new</span> Vector3f( <span class="float">0.00f</span>,  <span class="float">1.4f</span>, <span class="integer">0</span>));
join(body,       hips, <span class="keyword">new</span> Vector3f( <span class="float">0.00f</span>, -<span class="float">0.5f</span>, <span class="integer">0</span>));
join(uArmL, shoulders, <span class="keyword">new</span> Vector3f(-<span class="float">0.75f</span>,  <span class="float">1.4f</span>, <span class="integer">0</span>));
join(uArmR, shoulders, <span class="keyword">new</span> Vector3f( <span class="float">0.75f</span>,  <span class="float">1.4f</span>, <span class="integer">0</span>));
join(uArmL,     lArmL, <span class="keyword">new</span> Vector3f(-<span class="float">0.75f</span>,  <span class="float">0.4f</span>, <span class="integer">0</span>));
join(uArmR,     lArmR, <span class="keyword">new</span> Vector3f( <span class="float">0.75f</span>,  <span class="float">0.4f</span>, <span class="integer">0</span>));
join(uLegL,      hips, <span class="keyword">new</span> Vector3f(-<span class="float">0.25f</span>, -<span class="float">0.5f</span>, <span class="integer">0</span>));
join(uLegR,      hips, <span class="keyword">new</span> Vector3f( <span class="float">0.25f</span>, -<span class="float">0.5f</span>, <span class="integer">0</span>));
join(uLegL,     lLegL, <span class="keyword">new</span> Vector3f(-<span class="float">0.25f</span>, -<span class="float">1.7f</span>, <span class="integer">0</span>));
join(uLegR,     lLegR, <span class="keyword">new</span> Vector3f( <span class="float">0.25f</span>, -<span class="float">1.7f</span>, <span class="integer">0</span>));</code></pre></div></div>
<div class="paragraph"><p>Now the ragdoll is connected. If you ran the app now, the doll would collapse, but the limbs would stay together.</p></div></div>
<div class="sect2"><h3 id="attaching-everything-to-the-scene">Attaching Everything to the Scene</h3><div class="paragraph"><p>We create one (non-physical) Node named ragDoll, and attach all other nodes to it.</p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java">ragDoll.attachChild(shoulders);
ragDoll.attachChild(body);
ragDoll.attachChild(hips);
ragDoll.attachChild(uArmL);
ragDoll.attachChild(uArmR);
ragDoll.attachChild(lArmL);
ragDoll.attachChild(lArmR);
ragDoll.attachChild(uLegL);
ragDoll.attachChild(uLegR);
ragDoll.attachChild(lLegL);
ragDoll.attachChild(lLegR);</code></pre></div></div>
<div class="paragraph"><p>To use the ragdoll in a scene, we attach its main node to the rootNode, and to the PhysicsSpace.</p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java">rootNode.attachChild(ragDoll);
bulletAppState.getPhysicsSpace().addAll(ragDoll);</code></pre></div></div></div></div>
<div class="sect1"><h2 id="applying-forces">Applying Forces</h2><div class="sectionbody"><div class="paragraph"><p>To pull the doll up, you could add an input handler that triggers the following action:</p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java">Vector3f upforce = <span class="keyword">new</span> Vector3f(<span class="integer">0</span>, <span class="integer">200</span>, <span class="integer">0</span>);
shoulders.applyContinuousForce(<span class="predefined-constant">true</span>, upforce);</code></pre></div></div>
<div class="paragraph"><p>We can use the action to pick the doll up and put it back on its feet, or what ever. Read more about <a href="../../jme3/advanced/physics.html#forcesmoving_physical_objects">Forces</a> here.</p></div></div></div>
<div class="sect1"><h2 id="detecting-collisions">Detecting Collisions</h2><div class="sectionbody"><div class="paragraph"><p>Read the <a href="../../jme3/advanced/physics.html#responding_to_a_physicscollisionevent">Responding to a PhysicsCollisionEvent</a> chapter in the general physics documentation on how to detect collisions. You can detect collisions between limbs or between limbs and the floor, and trigger game events.</p></div></div></div>
<div class="sect1"><h2 id="best-practices">Best Practices</h2><div class="sectionbody"><div class="paragraph"><p>If you experience weird behaviour in a ragdoll – such as exploding into pieces and then reassembling – check your collision shapes. Verify you did not position the limbs too close to one another when assmebling the ragdoll. You typically see physical nodes being ejected when their collision shapes intersect, which puts physics in an impossible state.</p></div></div></div></div><div id="footer"><div id="footer-text">Version <br>Last updated 2017-11-14 05:28:25 +00:00</div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script><script>docsearch({
  apiKey: 'a736b6d93de805e26ec2f49b55013fbd',
  indexName: 'jmonkeyengine',
  inputSelector: '#doc-search',
  debug: false // Set debug to true if you want to inspect the dropdown
});</script></body></html>