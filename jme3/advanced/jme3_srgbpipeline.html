<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Asciidoctor 1.5.4"><title>Gamma Correction or sRGB pipline</title><link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css"></head><body class="article toc2 toc-left"><div id="header"><div id="toolbar"><a href="https://github.com/jMonkeyEngine/wiki/edit/master/src/docs/asciidoc/jme3/advanced/jme3_srgbpipeline.adoc"><i class="fa fa-pencil-square" aria-hidden="true"></i></a><a href="https://github.com/jMonkeyEngine/wiki/new/master/src/docs/asciidoc/jme3/advanced/"><i class="fa fa-plus-square" aria-hidden="true"></i></a><input dir="auto" style="position: relative; vertical-align: top;" spellcheck="false" autocomplete="off" class="searchbox__input aa-input" id="doc-search" name="search" placeholder="Search in the doc" required="required" type="search"></div><h1>Gamma Correction or sRGB pipline</h1><div class="details"><span class="author" id="author"></span><br><span id="revnumber">version ,</span> <span id="revdate">2016/03/17 20:48</span></div><div id="toc" class="toc2"><div id="toctitle">Table of Contents</div><ul class="sectlevel1"><li><a href="#overview">Overview</a><ul class="sectlevel2"><li><a href="#implementation">Implementation</a></li><li><a href="#should-you-use-this">Should you use this?</a></li></ul></li></ul></div></div><div id="content"><div class="sect2"><h3 id="overview">Overview</h3><div class="paragraph"><p>Here is a quick overview of what lies under the “Gamma Correction term.<br>
More in depth rundowns on the matter can be found here : <a href="http://http.developer.nvidia.com/GPUGems3/gpugems3_ch24.html">http://http.developer.nvidia.com/GPUGems3/gpugems3_ch24.html</a> and here <a href="http://www.arcsynthesis.org/gltut/Texturing/Tutorial%2016.html">http://www.arcsynthesis.org/gltut/Texturing/Tutorial%2016.html</a></p></div>
<div class="paragraph"><p>We consider color values to be linear when computing lighting. What does that means? That means that we assume that the color 0.5,0.5,0.5 is half way between black and white.<br>
The problem is that it’s not the case, or at least not when you look at the color through a monitor.<br>
CRT monitors had physical limitations that prevented them to have a linear way of representing colors. that means that 0.5,0.5,0.5 through a monitor is not half way between black and white (it’s darker). Note that black and white remains the same though.<br>
If we do not take that into account, the rendered images are overly darken and feels dull.<br>
LCD monitors still mimic this physical limitation (I guess for backward compatibility).<br>
<strong>Output correct colors</strong><br>
Gamma Correction is the technique that tends to correct the issue. Gamma is an power factor applied to the color by the monitor when lighting a pixel on screen (or at least a simplification of the function applied). So when we output the color, we have to apply the inverse power of this factor to nullify the effect : finalColor = pow(computedColor, 1/gamma);<br></p></div>
<div class="paragraph"><p><strong>Knowing what colors we have as input</strong><br>
The other aspect of gamma correction is the colors we get as input in the rendering process that are stored in textures or in ColorRGBA material params. Almost all image editors are storing color data in images already gamma corrected (so that colors are correct when you display the picture in a viewer of in a browser). Also most hand picked colors (in a color picker) can be assumed as gamma corrected as you most probably chose this color through a monitor display.
Such images or color are said to be in sRGB color space, meaning “standard RGB” (which is not the standard one would guess).
That means that textures and colors that we use as input in our shaders are not in a linear space. The issue is that we need them in linear space when we compute the lighting, else the lighting is wrong.
To avoid this we need to apply some gamma correction to the colors : (pow(color, gamma);
This only apply to textures that will render colors on screen (basically diffuse map, specular, light maps). Normal maps, height maps don’t need the correction.</p></div>
<div class="paragraph"><p>This is the kind of difference you can have :<br>
left is non corrected output, right is gamma corrected output.<br>
<span class="image"><img src="http://i.imgur.com/uNL7vw8.png" alt="uNL7vw8.png" width="" height=""></span></p></div>
<div class="sect2"><h3 id="implementation">Implementation</h3><div class="ulist"><ul><li><p>To handle proper gamma corrected ouput colors, Opengl expose an ARB extension that allows you to output a color in linear space and have the GPU automatically correct it : <a href="https://www.opengl.org/registry/specs/ARB/framebuffer_sRGB.txt">https://www.opengl.org/registry/specs/ARB/framebuffer_sRGB.txt</a></p></li><li><p>To handle the input, instead of classic RGBA8 image format, one can use SRGB8_ALPHA8_EXT which is basically RGBA in sRGB. Using this you specify the GPU that the texture is in sRGB space and when fetching  a color from it, the GPU will linearize the color value for you (for free). There are sRGB equivalent to all 8 bits formats (even compressed format like DXT).</p></li><li><p>But all textures don&#8217;t need this. For example, normal maps, height maps colors are most probably generated and not hand picked by an artist looking through a monitor. The implementation needs to account for it and expose a way to exclude some textures from the sRGB pipeline.</p></li></ul></div>
<div class="paragraph"><p>Gamma Correction in jME 3.0 is based on those three statements.</p></div>
<div class="admonitionblock important"><table><tr><td class="icon"><i class="fa icon-important" title="Important"></i></td><td class="content"><div class="paragraph"><p>Note that Gamma Correction is only available on desktop with LWJGL or JOGL renderer. They are not yet supported on Android or iOS renderers.</p></div></td></tr></table></div>
<div class="sect3"><h4 id="turning-gamma-correction-on-off">Turning Gamma Correction on/off</h4><div class="paragraph"><p>You can turn Gamma Correction on and off using the AppSettings. There is a method setGammaCorrection(boolean) that changes the setting.
use this in the main() method of your application :</p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java">AppSettings settings = <span class="keyword">new</span> AppSettings(<span class="predefined-constant">true</span>);
settings.setGammaCorrection(<span class="predefined-constant">true</span>);
app.setSettings(settings);</code></pre></div></div>
<div class="paragraph"><p>This setting is also exposed in the Settings dialog displayed when you launch a jME application.<br>
<span class="image"><img src="http://i.imgur.com/Lya1ldH.png" alt="Lya1ldH.png" width="400" height=""></span></p></div>
<div class="admonitionblock important"><table><tr><td class="icon"><i class="fa icon-important" title="Important"></i></td><td class="content"><div class="paragraph"><p>This is a short hand to enable both linearization of input textures and Gamma correction of the rendered output on screen.<br>
<strong>Both can be enabled separately</strong>.</p></div></td></tr></table></div>
<div class="sect4"><h5 id="enabling-output-gamma-correction">Enabling output Gamma Correction</h5><div class="paragraph"><p>You can enable or disable the Gamma correction of the rendered output by using:</p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java">renderer.setMainFrameBufferSrgb(<span class="type">boolean</span> srgb)</code></pre></div></div>
<div class="paragraph"><p>This will be ignored if the hardware doesn&#8217;t have the GL_ARB_framebuffer_sRGB or the GL_EXT_texture_sRGB.
This can be toggled at run time.</p></div>
<div class="paragraph"><p>This uses Opengl hardware gamma correction that uses an approximated Gamma value of 2.2 and uses the following formula : color = pow(color,1/gamma)</p></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content"><div class="paragraph"><p>This will not yield exact results, as the real gamma can vary depending on the monitor.<br>
If this is a problem, please refer to the “handling gamma correction in a post process section.</p></div></td></tr></table></div></div>
<div class="sect4"><h5 id="enabling-texture-linearization">Enabling texture linearization</h5><div class="paragraph"><p>You can enable or disable texture linearization by using</p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java">renderer.setLinearizeSrgbImages(<span class="type">boolean</span> linearize)</code></pre></div></div>
<div class="paragraph"><p>This will be ignored if the hardware doesn&#8217;t have the GL_ARB_framebuffer_sRGB or the GL_EXT_texture_sRGB.</p></div>
<div class="admonitionblock important"><table><tr><td class="icon"><i class="fa icon-important" title="Important"></i></td><td class="content"><div class="paragraph"><p>Toggling this setting at runtime will produce unexpected behavior for now. A change in this setting would need a proper reload of the context to work.</p></div></td></tr></table></div>
<div class="paragraph"><p>All images marked as in sRGB color space will be uploaded to the GPU using a sRGB image format.
Opengl hardware texture linearization also uses an approximated Gamma value of 2.2 and linearize the fetched texel color using the following formula : color = pow(color, gamma)<br>
As with output gamma correction this will not give exact result, but the error is less important since most image editor uses the same approximation to correct images and save them in sRGB color space.</p></div>
<div class="paragraph"><p>Not all image format have their sRGB equivalent, and only 8bit formats.
Here is an exhaustive list of the supported format and there equivalent :</p></div>
<div class="ulist"><ul><li><p>RGB8 : GL_SRGB8</p></li><li><p>RGBA8 : GL_SRGB8_ALPHA8</p></li><li><p>BGR8 : GL_SRGB8</p></li><li><p>ABGR8 : GL_SRGB8_ALPHA8</p></li><li><p>Luminance8 : GL_SLUMINANCE8</p></li><li><p>Luminance8Alpha8 : GL_SLUMINANCE8_ALPHA8</p></li><li><p>DXT1 : GL_COMPRESSED_SRGB_S3TC_DXT1</p></li><li><p>DXT1A : GL_COMPRESSED_SRGB_ALPHA_S3TC_DXT1</p></li><li><p>DXT3 : GL_COMPRESSED_SRGB_ALPHA_S3TC_DXT3</p></li><li><p>DXT5 : GL_COMPRESSED_SRGB_ALPHA_S3TC_DXT5</p></li></ul></div>
<div class="admonitionblock important"><table><tr><td class="icon"><i class="fa icon-important" title="Important"></i></td><td class="content"><div class="paragraph"><p>Conventionally only the rgb channels are gamma corrected, as the alpha channel does not a represent a color value</p></div></td></tr></table></div></div></div>
<div class="sect3"><h4 id="excluding-images-from-the-srgb-pipeline">Excluding images from the sRGB pipeline</h4><div class="admonitionblock important"><table><tr><td class="icon"><i class="fa icon-important" title="Important"></i></td><td class="content"><div class="paragraph"><p>Only loaded images will be marked as in sRGB color space, when using assetManager.loadTexture or loadAsset.<br>
The color space of an image created by code will have to be specified in the constructor or will be assumed as Linear if not specified.</p></div></td></tr></table></div>
<div class="paragraph"><p>Not all images need to be linearized. Some images don&#8217;t represent color information that will be displayed on screen, but more different sort of data packed in a texture.<br>
The best example is a Normal map that will contains normal vectors for each pixel. Height maps will contain elevation values. These textures must not be linearized.</p></div>
<div class="paragraph"><p>There is no way to determine the real color space of an image when loading it, so we must deduce the color space from the usage it&#8217;s loaded for. The usage is dictated by the material, those textures are used for, and by the material parameter they are assigned to.
One can now specify in a material definition file (j3md) if a texture parameter must be assumed as in linear color space, and thus, must not be linearized, by using the keyword -LINEAR next to the parameter (case does not matter).</p></div>
<div class="paragraph"><p>For example here is how the NormalMap parameter is declared in the lighting material definition.</p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code> // Normal map
 Texture2D NormalMap -LINEAR</code></pre></div></div>
<div class="paragraph"><p>When a texture is assigned to this material param by using material.setTexture(“NormalMap, myNormalTexture), the color space of this texture&#8217;s image will be forced to linear. So if you make your own material and want to use Gamma Correction, make sure you properly mark your textures as in the proper color space.</p></div>
<div class="paragraph"><p>This can sound complicated, but you just have to answer this question :  Does my image represent color data? if the answer is no, then you have to set the -Linear flag.</p></div></div>
<div class="sect3"><h4 id="colorrgba-as-srgb">ColorRGBA as sRGB</h4><div class="admonitionblock important"><table><tr><td class="icon"><i class="fa icon-important" title="Important"></i></td><td class="content"><div class="paragraph"><p>The r, g, b attributes of a ColorRGBA object are <strong>ALWAYS</strong> assumed in Linear color space.</p></div></td></tr></table></div>
<div class="paragraph"><p>If you want to set a color that you hand picked in a color picker, you should use the setAsSRGB method of ColorRGBA. This will convert the given values to linear color space by using the same formula as before : color = pow (color, gamma) where gamma = 2.2;</p></div>
<div class="paragraph"><p>If you want to retrieve those values from a ColorRGBA, you can call the getAsSRGB method. The values will be converted back to sRGB color Space.</p></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content"><div class="paragraph"><p>The return type of that method is a Vector4f and not a ColorRGBA, because as stated before, all ColorRGBA objects r,g,b attributes are assumed in Linear color space.</p></div></td></tr></table></div></div>
<div class="sect3"><h4 id="handling-rendered-output-gamma-correction-with-a-post-process-filter">Handling rendered output Gamma Correction with a post process filter</h4><div class="paragraph"><p>As stated before, the hardware gamma correction uses and approximated gamma value of 2.2.
Some may not be satisfied with that approximations and may want to pick a more appropriate gamma value.
You can see in some games some Gamma calibration screens, that are here to help the player pick a correct gamma value for the monitor he&#8217;s using.</p></div>
<div class="paragraph"><p>For this particular case, you can do as follow :</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Enable Gamma Correction global app setting.</p></li><li><p>Disable rendered output correction : renderer.setMainFrameBufferSrgb(false); (for example in the simpleInit method of your SimpleApplication).</p></li><li><p>Use the GammaCorrectionFilter in a FilterPostProcessor, and set the proper gamma value on it (default is 2.2).</p></li></ol></div></div></div>
<div class="sect2"><h3 id="should-you-use-this">Should you use this?</h3><div class="paragraph"><p>Yes. Mostly because it&#8217;s the only way to have proper lighting.
If you&#8217;re starting a new project it&#8217;s a no brainer…use it, period. And don&#8217;t allow the player to turn it off.</p></div>
<div class="paragraph"><p>Now if you already spent time to adjust lighting in your scenes, without gamma correction, turning it on will make everything too bright, and you&#8217;ll have to adjust all your lighting and colors again.
That&#8217;s why we kept a way to turn it off, for backward compatibility.</p></div></div></div></div><div id="footer"><div id="footer-text">Version <br>Last updated 2017-11-14 05:28:25 +00:00</div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script><script>docsearch({
  apiKey: 'a736b6d93de805e26ec2f49b55013fbd',
  indexName: 'jmonkeyengine',
  inputSelector: '#doc-search',
  debug: false // Set debug to true if you want to inspect the dropdown
});</script></body></html>