<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Asciidoctor 1.5.4"><title>Damage Systems Example</title><link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css"></head><body class="article toc2 toc-left"><div id="header"><div id="toolbar"><a href="https://github.com/jMonkeyEngine/wiki/edit/master/src/docs/asciidoc/jme3/contributions/entitysystem/examples/damagesystem.adoc"><i class="fa fa-pencil-square" aria-hidden="true"></i></a><a href="https://github.com/jMonkeyEngine/wiki/new/master/src/docs/asciidoc/jme3/contributions/entitysystem/examples/"><i class="fa fa-plus-square" aria-hidden="true"></i></a><input dir="auto" style="position: relative; vertical-align: top;" spellcheck="false" autocomplete="off" class="searchbox__input aa-input" id="doc-search" name="search" placeholder="Search in the doc" required="required" type="search"></div><h1>Damage Systems Example</h1><div class="details"><span class="author" id="author"></span><br><span id="revnumber">version ,</span> <span id="revdate">2016/03/17 20:48</span></div><div id="toc" class="toc2"><div id="toctitle">Table of Contents</div><ul class="sectlevel1"><li><a href="#the-components">The Components</a><ul class="sectlevel2"><li><a href="#the-healthcomponent">The HealthComponent</a></li><li><a href="#the-damagecomponent">The DamageComponent</a></li></ul></li><li><a href="#the-appstate">The AppState</a></li><li><a href="#usage">Usage</a></li></ul></div></div><div id="content"><div id="preamble"><div class="sectionbody"><div class="paragraph"><p>As written in the Entity System Advanced article, there should only be one class which changes one special Component.
This makes the code easy to debug and prevents component changes from being skipped.</p></div></div></div>
<div class="sect2"><h3 id="the-components">The Components</h3><div class="sect2"><h3 id="the-healthcomponent">The HealthComponent</h3><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">HealthComponent</span> <span class="directive">extends</span> <span class="predefined-type">Component</span> {

    <span class="directive">public</span> <span class="type">float</span> health;

    <span class="directive">public</span> HealthComponent(<span class="type">float</span> health)
    {
        <span class="local-variable">this</span>.health = health;
    }

    <span class="directive">public</span> <span class="type">float</span> getHealth()
    {
        <span class="keyword">return</span> health;
    }

}</code></pre></div></div></div>
<div class="sect2"><h3 id="the-damagecomponent">The DamageComponent</h3><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java">    <span class="directive">private</span> <span class="type">float</span> damage;
    <span class="directive">private</span> EntityId target;

    <span class="directive">public</span> DamageComponent(EntityId target, <span class="type">float</span> damage)
    {
        <span class="local-variable">this</span>.damage=damage;
        <span class="local-variable">this</span>.target=target;
    }

    <span class="directive">public</span> <span class="type">float</span> getDamage()
    {
        <span class="keyword">return</span> damage;
    }

    <span class="directive">public</span> EntityId getTarget()
    {
        <span class="keyword">return</span> target;
    }</code></pre></div></div></div></div>
<div class="sect1"><h2 id="the-appstate">The AppState</h2><div class="sectionbody"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DamageAppState</span> <span class="directive">extends</span> AbstractAppState {

    EntitySet damageSet;
    EntitySet healthSet;

   <span class="directive">public</span> <span class="type">void</span> initialize(AppStateManager stateManager, Application app) {
        EntitySystem entitySystem = ((Main)app).getEntitySystem();
        damageSet = entitySystem.getEntitySet(DamageComponent.class);
        healthSet = entitySystem.getEntitySet(HealthComponent.class);
    }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> update(<span class="type">float</span> tpf) {

       <span class="predefined-type">Map</span>&lt;EntityId,<span class="predefined-type">Float</span>&gt; damageSummary = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>();

       damageSet.applyChanges();
       healthSet.applyChanges();

       <span class="predefined-type">Iterator</span>&lt;<span class="predefined-type">Entity</span>&gt; iterator = damageSet.getIterator();
       <span class="keyword">while</span>(iterator.hasNext())
       {
           <span class="predefined-type">Entity</span> entity = iterator.next();
           DamageComponent dc = entity.getComponent(DamageComponent.class);

           <span class="type">float</span> f = <span class="integer">0</span>;
           <span class="keyword">if</span>(damageSummary.containsKey(dc.getTarget()))
           {
               f = damageSummary.get(dc.getTarget());
           }

           f += dc.getDamage();
           damageSummary.put(dc.getTarget(),f);

           entity.destroy();
       }

       <span class="predefined-type">Iterator</span>&lt;EntityId&gt; keyIterator = damageSummary.keySet().iterator();
       <span class="keyword">while</span>(keyIterator.hasNext())
       {
           EntityId entityId = keyIterator.next();
           <span class="type">float</span> damage = damageSummary.get(entityId);

           <span class="predefined-type">Entity</span> entity = healthSet.getEntity(entityId);
           <span class="keyword">if</span>(entity != <span class="predefined-constant">null</span>)
           {
               HealthComponent hc = entity.getComponent(HealthComponent.class);
               <span class="type">float</span> newLife = hc.getHealth()-damage;

               <span class="keyword">if</span>(newLife &lt; <span class="integer">0</span>)
               {
                   entity.removeComponent(HealthComponent.class);
               }<span class="keyword">else</span>{
                   entity.setComponent(<span class="keyword">new</span> HealthComponent(newLife));
               }
           }
       }
   }

}</code></pre></div></div></div></div>
<div class="sect1"><h2 id="usage">Usage</h2><div class="sectionbody"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//Create a new Entity System</span>
entitySystem = <span class="keyword">new</span> EntitySystem(<span class="keyword">new</span> MapEntityData());

<span class="comment">//Add the DamageAppState to the Application</span>
stateManager.attach(<span class="keyword">new</span> DamageAppState());

<span class="comment">//Create a new Entity with 100 HP</span>
EntityId healthEntity = entitySystem.newEntity(<span class="keyword">new</span> HealthComponent(<span class="integer">100</span>));

<span class="comment">//Create a new Damage Entity who deals 5 damage to the health entity</span>
entitySystem.newEntity(<span class="keyword">new</span> DamageComponent(healthEntity,<span class="integer">5</span>));</code></pre></div></div></div></div></div><div id="footer"><div id="footer-text">Version <br>Last updated 2017-11-14 05:28:25 +00:00</div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script><script>docsearch({
  apiKey: 'a736b6d93de805e26ec2f49b55013fbd',
  indexName: 'jmonkeyengine',
  inputSelector: '#doc-search',
  debug: false // Set debug to true if you want to inspect the dropdown
});</script></body></html>